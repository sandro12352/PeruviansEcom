
<div class="container mt-4">
  <div class="row">
    <!-- Columna izquierda -->
    <div class="col-md-8">
      
      <!-- Datos del Cliente -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Datos del Cliente</h5>
            <!-- Indicador de usuario logueado -->
            <span *ngIf="isAuthenticated" class="badge bg-success">
              <i class="bi bi-person-check"></i> Usuario logueado
            </span>
          </div>
          
        <form [formGroup]="clienteForm" class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nombre completo</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="nombre"
              placeholder="Ingrese su nombre completo"
              [readonly]="isAuthenticated && clienteForm.get('nombre')?.value">
            <div *ngIf="isAuthenticated && clienteForm.get('nombre')?.value" class="valid-feedback">
                Datos cargados automáticamente
              </div>

               <div *ngIf="clienteForm.get('nombre')?.hasError('required')" class="invalid-feedback d-block">
                El nombre completo es obligatorio.
              </div>

              <div *ngIf="clienteForm.get('nombre')?.hasError('nombreIncompleto')" class="invalid-feedback d-block">
                  Debe ingresar al menos nombre y apellido.
                </div>

            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">DNI</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="dni"
                placeholder="12345678"
                maxlength="8"
                [readonly]="isAuthenticated && clienteForm.get('dni')?.value">
              <div *ngIf="isAuthenticated && clienteForm.get('dni')?.value" class="valid-feedback">
                Datos cargados automáticamente
              </div>

              <div *ngIf="clienteForm.get('dni')?.invalid" class="invalid-feedback d-block">
                  DNI es obligatorio y debe tener 8 digitos
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input 
                type="email" 
                class="form-control" 
                formControlName="email"
                placeholder="ejemplo@correo.com"
                [readonly]="isAuthenticated && clienteForm.get('email')?.value">
              <div *ngIf="isAuthenticated && clienteForm.get('email')?.value" class="valid-feedback">
                Datos cargados automáticamente
              </div>


               <div *ngIf="clienteForm.get('email')?.invalid" class="invalid-feedback d-block">
                  Email es obligatorio
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Teléfono</label>
              <input 
                type="tel" 
                class="form-control" 
                formControlName="telefono"
                maxlength="9"
                placeholder="987654321">
              <div *ngIf="isAuthenticated && clienteForm.get('telefono')?.value" class="valid-feedback">
                Datos cargados automáticamente
              </div>


              <div *ngIf="clienteForm.get('telefono')?.invalid" class="invalid-feedback d-block">
                  Teléfono es obligatorio y debe tener 9 digitos
              </div>
            </div>
          </form>



          <!-- Mensaje informativo para usuarios no logueados -->
          <div *ngIf="!isAuthenticated" class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            ¿Ya tienes cuenta? <a routerLink="/auth" class="alert-link">Inicia sesión</a> para cargar automáticamente tus datos.
          </div>
        </div>
      </div>

      <!-- Dirección -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Dirección de Entrega</h5>

            <!-- Si ya tiene dirección -->
            <div *ngIf="isAuthenticated && currentUser?.direccion; else nuevaDireccion"
                class="d-flex justify-content-between align-items-center">
              <div>
                <p class="card-text mb-0 text-success">
                  {{ direccionCliente }}
                </p>
                <small class="text-success">
                  <i class="bi bi-check-circle"></i> Cargada desde tu perfil
                </small>
              </div>
              <button class="btn btn-outline-primary" (click)="modificarDireccion()">
                Cambiar
              </button>
            </div>

            <!-- Si no hay dirección, mostrar formulario -->
            <ng-template #nuevaDireccion>
              <form>
                <!-- Departamento -->
                <div class="mb-3">
                  <label class="form-label">Departamento</label>
                  <select class="form-select" [(ngModel)]="selectedDepartamento" name="departamento"
                          (change)="onDepartamentoChange()">
                    <option [ngValue]="null">Selecciona...</option>
                    <option *ngFor="let d of departamentos" [ngValue]="d">{{ d.nombre }}</option>
                  </select>
                </div>

                <!-- Provincia -->
                <div class="mb-3">
                  <label class="form-label">Provincia</label>
                  <select class="form-select" [(ngModel)]="selectedProvincia" name="provincia"
                          (change)="onProvinciaChange()" [disabled]="!selectedDepartamento">
                    <option [ngValue]="null">Selecciona...</option>
                    <option *ngFor="let p of provincias" [ngValue]="p">{{ p.nombre }}</option>
                  </select>
                </div>

                <!-- Distrito -->
                <div class="mb-3">
                  <label class="form-label">Distrito</label>
                  <select class="form-select" [(ngModel)]="selectedDistrito" name="distrito"
                          [disabled]="!selectedProvincia">
                    <option [ngValue]="null">Selecciona...</option>
                    <option *ngFor="let dis of distritos" [ngValue]="dis">{{ dis.nombre }}</option>
                  </select>
                </div>

                <!-- Dirección exacta -->
                <div class="mb-3">
                  <label class="form-label">Dirección Exacta</label>
                  <input type="text" class="form-control" [(ngModel)]="direccionExacta" name="direccionExacta"
                        placeholder="Ej. Av. Siempre Viva 123, referencia..." [disabled]="!selectedDistrito">
                </div>
              </form>
            </ng-template>
          </div>
        </div>



      <!-- Medio de Pago -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Medio de Pago</h5>

          <div class="d-flex flex-column gap-3 mb-3">

            <label
              class="payment-option border rounded d-flex justify-content-between align-items-center gap-3 p-3"
              [class.selected]="selectedPayment === 'card'"
              (click)="selectPayment('card')"
            >
              <div class="d-flex align-items-center gap-1">
                  <img src="./visa.png"alt="Pago con tarjeta" width="50" height="50"/>
                  <img src="./mastercard.png"alt="Pago con tarjeta" width="50" height="50"/>
                  <img src="./americanexpress1.png"alt="Pago con tarjeta" />
                  <img src="./americaexpress.png"alt="Pago con tarjeta" />
              <span class="ms-2">Pago con tarjeta</span>
              </div>
              <i class="bi bi-chevron-down fs-5"></i>
            </label>

            <!-- Formulario tarjeta -->
            <div *ngIf="selectedPayment === 'card'" class="border rounded p-3">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Datos de la tarjeta</h6>
                <small class="text-muted">
                  <i class="bi bi-shield-lock"></i> Información segura
                </small>
              </div>
              
              <form #cardForm="ngForm">
               <div class="mb-3 position-relative">
                <input
                  type="text"
                  id="cardNumber"
                  name="card_number"
                  class="form-control ps-5"
                  placeholder="Número de tarjeta"
                  maxlength="19"
                  [(ngModel)]="tarjeta.card_number"
                  (input)="onCardNumberChange($event)"
                  required
                />
                <i class="bi bi-credit-card position-absolute fs-4 text-dark" 
                  style="top: 55%; left: 15px; transform: translateY(-50%); color: #6c757d; pointer-events:none;"></i>
              </div>

              <div class="row">
                <div class="col-6 mb-3">
                  <label for="expiryDate" class="form-label">Fecha expiración</label>
                  <input
                    type="text"
                    id="expiryDate"
                    name="expiryDate"
                    class="form-control"
                    placeholder="MM/AA"
                    maxlength="5"
                    [(ngModel)]="tarjeta.expiration_month"
                    (input)="onExpiryDateChange($event)"
                    required
                  />
                </div>
                <div class="col-6 mb-3">
                  <label for="cvv" class="form-label">CVV</label>
                  <input
                    type="password"
                    id="cvv"
                    name="cvv"
                    class="form-control"
                    placeholder="123"
                    maxlength="3"
                    [(ngModel)]="tarjeta.cvv"
                    required
                  />
                </div>
              </div>
              </form>
              
              <div class="alert alert-warning">
                <small>
                  <i class="bi bi-exclamation-triangle"></i>
                  Los datos de tarjeta no se guardan por seguridad. Deberás ingresarlos en cada compra.
                </small>
              </div>
            </div>

            <label
              class="payment-option border rounded d-flex justify-content-between align-items-center gap-3 p-3"
              [class.selected]="selectedPayment === 'yape'"
              (click)="selectPayment('yape')"
              [class.disabled]="loadingYape"
            >
              <div class="d-flex gap-1 align-items-center">
                <img src="./yape.png" alt="Pago con Yape"  />
                <img src="./plin.png" alt="Pago con Plin"  />
                <span *ngIf="!loadingYape" class="ms-2">Paga con Yape o Plin</span>
                <span *ngIf="loadingYape">Cargando...</span>
              </div>
            </label>


           <!-- Pago con Yape -->
<!-- Pago con Yape -->
<div *ngIf="selectedPayment === 'yape'" class="border rounded p-3 shadow-sm">
  <div class="text-center mb-4">
    <img src="./yape2.png" width="50" height="50" alt="Yape">
    <p class="fs-5 mt-2 mb-0"><strong>Paga con Yape</strong></p>
    <small class="text-muted">Sigue estos 3 pasos sencillos</small>
  </div>
  
  <!-- Paso 1 -->
  <div class="d-flex align-items-center mb-3 ">
    <span class="badge bg-list rounded-circle me-3">1</span>
    <p class="mb-0">
      Escanea el <strong>código QR</strong> que aparecerá al confirmar tu compra.
    </p>
  </div>

  <!-- Paso 2 -->
  <div class="d-flex align-items-center  mb-3 ">
    <span class="badge bg-list rounded-circle me-3">2</span>
    <p class="mb-0">
      Ingresa el <strong>monto exacto</strong> en tu aplicación Yape.
    </p>
  </div>

  <!-- Paso 3 -->
  <div class="d-flex align-items-center ">
    <span class="badge bg-list rounded-circle me-3">3</span>
    <p class="mb-0">
      Confirma el pago y espera la <strong>validación automática</strong>.
    </p>
  </div>
</div>




          </div>
        </div>
      </div>
    </div>

    <!-- Columna derecha - Resumen -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Resumen de Compra</h5>

          <!-- Lista de productos -->
          <div  class="d-flex justify-content-between align-items-center border-bottom py-2">
         
            Productos({{ cantidadProductos( ) }})
            <span class="fw-bold">S/ {{ calcularTotalProductos() | number:'1.2-2' }}</span>
          </div>

          <!-- Totales -->
          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span>S/ {{ subtotal | number:'1.2-2' }}</span>
            </div>
            <div class="d-flex justify-content-between" *ngIf="descuento > 0">
              <span>Descuento</span>
              <span class="text-success">- S/ {{ descuento | number:'1.2-2' }}</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total</span>
              <span>S/ {{ total | number:'1.2-2' }}</span>
            </div>
          </div>

          <button 
            class="btn-pagar w-100 mt-3" 
            [disabled]="clienteForm.invalid"
            (click)="pagar()">
            <span *ngIf="!procesandoPago" >CONFIRMAR COMPRA S/ {{ total | number:'1.2-2' }}</span>
            <span *ngIf="procesandoPago">Procesando...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="qrModal"
  tabindex="-1"
  aria-labelledby="qrModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-3">
      <h5 class="modal-title mb-3">Escanea con Yape</h5>
      <div >
        <img  alt="QR de Yape" class="img-fluid" />
      </div>
      <ng-template #loadingQr>
        <p>Generando QR...</p>
      </ng-template>
    </div>
  </div>
</div>



<!-- Overlay que bloquea todo -->
<div *ngIf="loadingYape" class="overlay">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>